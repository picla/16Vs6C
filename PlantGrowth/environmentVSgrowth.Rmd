---
title: "environment"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = F)
library(tidyverse)
library(glmnet)
library(glinternet)
library(caret)
library(leaps)
knitr::opts_knit$set(root.dir = '/Volumes/nordborg/user/pieter.clauw/Documents/Experiments/UltimateQandD/')
```

## Environmental correlations with growth


```{r Data}
# growth data
growth <- read_csv('Data/Growth/GWAS/growthPheno.csv')
# worldclim data
worldclim <- read_csv('/Volumes/nordborg/user/pieter.clauw/Documents/Source/Accessions/2029_modified_MN_SH_wc2.0_30s_bilinear.csv')
#clim <- read_csv('/Volumes/nordborg/user/pieter.clauw/Documents/Source/Accessions/araclim.csv')
```
```{r general variables}
temperatures <- c('16C', '6C')
phenotypes <- c('LGR', 'rosette35DAS')
```

```{r tidying}
#clim %>%
#  mutate(autumnTemp = rowMeans(select(., tmean_10, tmean_11, tmean_12)))

growth.long <- growth %>%
  # remove accesisons 7471 from analysis. this accession lacks known coordinates
  filter(growth$accession != 7471) %>%
  select(everything(), -autumnTemp) %>%
  pivot_longer(
    cols = contains('_'),
    names_to = c(".value", "temperature"),
    names_sep = '_')

growthClim <- inner_join(growth.long, worldclim, by = 'accession') %>%
  select(accession, rosette35DAS, LGR, temperature, everything())
```



```{r per temperature}
# do this for each temperature and for each phenotype (LGR and rosette area)
lasso.clim <- data.frame(phenotype = character(), temperature = character(), name = character(), coefficient = numeric())
for (pheno in phenotypes)
{
  nonPheno <- phenotypes[phenotypes != pheno]
  for (temp in c(temperatures, 'response'))
  {
    if (temp == 'response' & pheno == 'rosette35DAS'){next()}
    
    x <- growthClim %>%
      filter(temperature == temp) %>%
      select(pheno, everything(), -accession, -nonPheno, -temperature, -longitude, -latitude) %>%
      select_if(~ !any(is.na(.))) %>%
      model.matrix(formula(.[[pheno]] ~ .), data = .)
    x <- x[,-c(1,2)]
    
#growthClim %>%
#  filter(temperature == temp) %>%
#  select(LGR, autumnTemp:tmin_9) %>%
#  model.matrix(LGR ~ ., data = .)
  
     y <- growthClim %>%
      filter(temperature == temp) %>%
      select(pheno) %>%
      .[[pheno]]

    # find optimal lambda
    cv.out <- cv.glmnet(x,y, alpha = 1)
    plot(cv.out)  
    lambda.min <- cv.out$lambda.min
    # save significant coefficients
    coef.temp <- coef(cv.out, s = lambda.min)
    lasso.clim <- lasso.clim %>%
      bind_rows(data.frame(phenotype = pheno, temperature = temp, name = coef.temp@Dimnames[[1]][coef.temp@i + 1], coefficient = coef.temp@x))  
  }
}
```

```{r find NA accessions}
naclim <- growthClim %>%
  filter(temperature == temp) %>%
  select(accession, contains('WC'))
```


```{r stepwise regression}
for (pheno in phenotypes)
{
  nonPheno <- phenotypes[phenotypes != pheno]
  for (temp in c(temperatures, 'response'))
  {
# Set seed for reproducibility
set.seed(123)

      x <- growthClim %>%
        filter(temperature == temp) %>%
        select(pheno, everything(), -nonPheno, -accession, -nonPheno, -temperature, -longitude, -latitude)
      
      
      %>%
        select_if(~ !any(is.na(.)))
    
    # Set up repeated k-fold cross-validation
    train.control <- trainControl(method = "cv", number = 10)
# Train the model
    step.model <- train(LGR ~., data = x,
                    method = "leapSeq", 
                    tuneGrid = data.frame(nvmax = 1:5),
                    trControl = train.control
                    )
step.model$results
step.model$bestTune
summary(step.model$finalModel)
  }
}
```





```{r glinternet}
for (pheno in phenotypes)
{
  for (temp in c(temperatures, 'response'))
  {
    if (temp == 'response' & pheno == 'rosette35DAS'){next()}
    y <- growthClim %>%
      filter(temperature == temp) %>%
      select(pheno) %>%
      .[[pheno]]

    # define numeric variables
    numVar <- growthClim %>%
      filter(temperature == temp) %>%
      select(autumnTemp:tmin_9) %>%
      sapply(., is.numeric)

    # set number of levels for each variable (1 for continuous variables)
    numLevels <- growthClim %>%
      filter(temperature == temp) %>%
      select(autumnTemp:tmin_9) %>%
      mutate_if(!(numVar), as.factor) %>%
      sapply(nlevels)
    numLevels[numLevels == 0] <- 1

    # specify x matrix
    x <- growthClim %>%
      filter(temperature == temp) %>%
      select(autumnTemp:tmin_9)
      mutate_if(!(numVar), as.factor) %>%
      mutate_if(is.factor, as.integer) %>%
      mutate_if(!(numVar), function(x)(x -1))


    # specify pairwise interactions
    tempIdx <- which(colnames(x) == 'temperature')
    interactionPairs <- matrix(c(rep(tempIdx, ncol(x) - tempIdx), c((tempIdx + 1):ncol(x))), ncol = 2)
  

    # find optimal lambda
    set.seed(19)
    cv_fit <- glinternet.cv(x, y, numLevels, nLambda = 100, numCores = 8)
    #cv_fit <- glinternet.cv(x, y, numLevels, nFolds = 10, nLambda = 10000)
    plot(cv_fit)
    lambda.min.idx <- which(cv_fit$lambda == cv_fit$lambdaHat)

    # coefficents
    ## main
    coefs <- coef(cv_fit$glinternetFit)[[lambda.min.idx]]
    idx_cat <- (1:length(numVar))[!numVar]
    names(numLevels)[idx_cat[coefs$mainEffects$cat]]
    idx_num <- (1:length(numVar))[numVar]
    names(numLevels)[idx_num[coefs$mainEffects$cont]]
    ## interactions
    
}
}
```

